设计文档
====
## 个人信息
----
学号：19302010074<br>
姓名：张诗涵<br>
## 地址
----
Github地址：https://github.com/yoyazhang/My-webProject2<br>
## 项目完成情况
----
加载图片、图片信息页面的链接创建、登录、注册等功能其实和lab大体上都无差，只要懂了原理并修改一下就能实现，因此这里只涉及我在做的时候觉得需要自己的思考
和学习的技术，将比较困难的、载过的坑进行分享：<br>
1. 二级联动的实现：总体来说就是当用户选择国家（国家的value发生变化时）调用函数用ajax向服务器端异步请求数据并根据得到的结果加载城市选择器的选项。服务器端通过一个
php处理后将得到的数据（包括城市名称和code）以json的形式发和客户端，js文件中在php处理成功后执行加载的功能，parse json后为城市的每个选项赋值。在浏览页和上
传页的二级联动稍有不同，后者是把所有的城市和国家的名称、代号全部拉下来并展示、让用户选择；而后者则考虑到那些没有任何图片的城市、国家用户搜索只会浪费时
间、浪费感情，所以在从数据库拉数据时用的sql只选取了那些有图片的国家及其有图的部分城市，提高用户找到图片的效率。
2. 上传/修改功能：在修改功能中，我调整了一部分二级联动，如果能得到是已有的图片、且有城市信息就将那一行自动选上（也就是我为国家这一selector绑定了load
完成后执行获取服务器端数据的函数的功能）；上传数据、对数据库内容更新：写之前完全不知道应当如何将用户上传的图片移动到目标文件夹，后来网上查到了移动图
片到了对应函数：move_uploaded_file($temp_file,$path);
3. 注册功能的有效性检查：用户名、邮箱是否有效、密码强度是否足够、两次密码是否相同是在客户端客户端检查的，前三个通过正则表达式，第四个就直接检查，不符
合要求的就通过setCustomValidity（）提醒用户，要注意的是一定要加上在检查无误后要setCustomValidity（''）否则就会改正后也依然报错。对于是否有用户名重复，
则是提交后到服务器端获取数据核对，不对的话就alert并要求重新注册，注册成功后将密码哈希加盐后连同用户名、编号、邮箱以及注册时间记录进数据库中。
4. 详情页的收藏功能：用的是刷新的方式（口合口合），collected的按钮按下后js会将该页面的url之后加上status=0并重新加载（kudo按钮按下后status为1）而
在页面加载的过程中就会根据status的不同进行处理（delete或者insert，如果数据库中显示已存在这样的收藏就会返回，避免由于用户自行刷新导致的重复收藏）
5. 收藏页的取消收藏功能：用的是ajax异步处理的方式。每张图片对应的按钮的alt属性是这张图的ImageID，这样js文件中就能通过这个属性获取到id，当用户点击取消
收藏后向调用，利用ajax发送请求，请求在ArrangeFavorPics.php中处理，方法为post，一并发送的请求为id=这张图的ImageID（即前文说的通过alt属性拿到的值）。
ArrangeFavorPics.php会将有对应用户名和ImageID的那行数据删除（此外，在删除自己发布的图片时，也会将与之关联的别人的收藏都删除）
6. 对二级联动中json传输中断问题的解决：把人口为0的城市删掉。理由：要回答这个问题，我们首先要知道为什么在处理方式只要逻辑自洽即可的要求下应该选择
继续保留二级联动（原来我也觉得这个功能很难做、无聊，用户想要啥就让他写啥不就好了）但是！让用户自己写会有以下几个问题：1、写完不做检测那么势必
许多人的大小写、是否有空格、使用英语还是各自的语言等等都不同，那么由于不能保证一样，前面加载图片信息的功能中通过citycode来标记从而找到对应城市的能力
基本就是废了，也就是说对应这种方式，只有在travelimage表中直接记录城市名才可以，那么这样的话由于每个人的写法都不同，浏览页通过热门城市直接filter或者国
家城市二级联动的功能也就不可能了（即使我不用code用名字直接匹配也不可能，因为每个人的大小写空格中英文都不同，所以不太能轻松地匹配到）；当然还有别的补救
措施，比如我输入完之后检查用户的格式是否正确（输入上海，问用户是否想输入的是Shanghai，用户确认则用Shanghai这一数据加入数据库，与之相匹配的citycode当然
也能拿到，browser的二级联动就不受影响了）但是权衡一下我觉得用这种方式工作量更大。<br>
那么在明确即使ta可以接受输入框、我们也要选二级联动的前提下，我认为解决问题总比留在那里好，而且人口为0的城市（以中国为例）大部分是附属于某个中小型
城市的县，地址具体到市已经足够方便对此有兴趣的用户找到相对应的地点并前往了，太细枝末节反而不利于人们了解（比如我的图片是在花鸟岛拍的，city设为花鸟
岛其实不如设置为浙江舟山更能让其他用户了解它的具体位置）。补充方案：如果能够自己设计数据库的话我认为加入一个省级数据（即三级联动）可能会更方便，但
现在没有条件，所以就用删除小城市的方式来解决了。
## bonus完成情况
----
1. 哈希加盐算法：用了phpass类库，通过new 一个hasher进行哈希加盐并检验。原理分为两步：一个是哈希，即通过一定的处理将密码变为无关联且无序的乱码而非明
文储存，但是这依然存在风险，例如可以通过先尝试常用密码的常用哈希得到结果进行比对以推测出哈希方式进行攻击，因此有了第二个是加盐，即为每个密码首先加一个
盐并在新密码上进行哈希，这样即使原本一样的密码得到的结果也会完全不同。那为什么要用类库而不是自带的或者自己写呢？自己写的话安全度很难得到保证、并且会
存在盐值是随机还是固定的？随机的话是不是也要保存等等不安全成分；同时自带的函数貌似已经被破解了，所以还是用phpass已经完成的实践最能保证安全。
2. 前端类库使用心得：<br>
jquery：我觉得最大的特点是很多功能的考虑更人性化，text()和val()函数同时可以实现得到内容以及设置新的内容；而类似css的选择器让添加功能、批量修改更加方便
、代码数量也减少很多，特别是在搜索页功能实现中，我想获取当前用户选择的是何方式，只要$('input[name="SearchMethod"]:checked').val()就可以得到，不用得到
对应元素再分别判断其checked属性，减少了代码冗余；所有功能里我用到最人性化的是remove()会将该元素和其所有的子元素都移除这个功能，而原本的js中如果想让一
个元素消失，设置了display：none后其子元素依然存在且显示，每个都分别设置就很麻烦；当然有时候也会碰到疑惑的时候，它似乎不能支持jq和js混杂着写，比如我用
$("#xxxx").onclick = function();就会没有用（jq中设置点击触发函数的语法应该是$("#xxx").click(function (){});）而在不熟练的时候使用就会两个互相混杂最
后出错。<br>
bootstrap:并没有使用特别多，主要是用了它的轮播图功能，能直接做出来一个完整的轮播图当然是方便的、它整体的效果也很干净高级（下拉菜单、导航栏同理），像
这种通过变换class来改变样式的模板是一个很棒的设计和制作思路，下次做自己网站的设计也可以从这个角度去考虑。
3. 服务器部署：购买了腾讯云高校学生优惠的10块服务器，用的是ubantu系统，按照文档里的提示换了密码和用户名；之后在控制台尝试了登录，ssh方式不断拒绝（但是我查了端口，22是开放的），后来换了vnc
方式可以正常登录（同学推荐的远程连接方式我也试了，然而我的操作系统是win10家庭版没有这个功能TUT），但是登录后实例中显示的似乎还是未登录状态（即它最右边的
几个操作方式里还是显示'登录'而不是类似管理的功能，此为一大迷惑；接下来文档传输我filezilla和winscp都下载了，前者我压根没看到tip中截图显示'新站点'那个页面和功能
，然后我换了winscp，类似通过主机名、用户名、密码登录的页面到达了，但是我用公网ip、前面设置的用户名和密码反复尝试后都显示拒绝接入（此处应有微笑脸）。我
根据自己体验和同学的经验认为远程连接似乎更方便一点，这是我个人一开始操作系统安装版本没选对的锅，暑假会尽快升级，不影响后续学习，有机会也希望能尝试用这个方式
实现部署服务器并发布，这次就当是体验一下为以后长教训吧。
## 其他完成的功能
----
页码功能的完整实现：除了文档要求的以外，能完成不止实现前5页、根据总页数和当前的页数显示页码，并正确跳转、显示图片的功能。
根据总的页数决定输出的页码表的样子，如当前在第3页，并且总页数大于等于5，那么就会输出到首页、上一页、1、2、3、4、5页、下一页、到尾页的图标和链接。
如果总页数为4，则第五页的链接就不会有，而若总页数为8，当前页码为6，那么输出的就是4、5、6、7、8；基本的逻辑是保证当前页码在最中间、总的页码数量为
5个（即前后各两个）并设为红色字突出（别的页码为蓝色），为了保证尽量5个，在首页的话会考虑如果总页数大于3就会输出4的链接，大于4就输出5的链接，以此类推。
## 建议
-----
我想对本次pj的bonus部分提出一点意见：
1. 我个人认为本门课程既然主要不是涉及服务器端，我们整个学期的学习重心都是js（js占了整个学期的小半，结果最后在pj里就是个工具人……）、html、css，php都只
在最后几周涉及了最简单的部分，那考核的重心难道不应该放在前端设计的美观、功能的全面、贴心、如何实现更安全等等功能的拓展上吗，结果反而这个不一定能计分、一个课程里
都不是重心的东西占了15分，迷惑子。打个比方，这不就好像我选的戏剧表演期末考核内容是表演仲夏夜之梦的片段，然后老师说bonus是你们研究一下文艺复兴时期英国艺术
发展的情况与脉络结合其历史与现实用一篇论文谈一谈莎翁背后展现的英国现代与传统矛盾的交融一样很不适恰吗？
以及……服务器难道是别的课上不会学的吗（如果真的是不学的，那alright我暑假自己再搞吧）。总体来说，我认为这样的bonus设计是有问题的。
2. 时间安排上，我当然也懂每一部分这样安排的周期，但是无论如何结果就是————如果我不提前自学，lab10出来之前我对pj该怎么开始一点思路都没有（那些语言和方法上完课确实都会了，
但是我不知如何下笔），lab10出来以后我才知道原来都是要用php连接数据库去查询并获得的，那任何一个正常按教学进度走的不都只有最后一两周时间写吗……这样的话也没有什么所谓的平均吧……


